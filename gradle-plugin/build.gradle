plugins {
    id 'java'
}

group = 'net.example'
version = '1.0.0'

repositories {
    mavenCentral()
}

// 1. Create the Jar
jar {
    manifest {
        attributes(
                'Main-Class': 'net.example.ExampleMod.java'
        )
    }
}

// 2. Publish Task
task publishToModtale(type: Exec) {
    dependsOn build

    // Inputs from Environment
    def apiKey = System.getenv("MODTALE_KEY")
    def projectId = System.getenv("MODTALE_PROJECT_ID")

    // Locate the jar
    def jarFile = layout.buildDirectory.file("libs/${project.name}-${project.version}.jar").get().asFile

    doFirst {
        if (!apiKey || !projectId) {
            throw new GradleException("Error: MODTALE_KEY and MODTALE_PROJECT_ID env vars are required.")
        }
        if (!jarFile.exists()) {
            throw new GradleException("Error: Jar file not found at ${jarFile}")
        }
    }

    // Curl Upload Command
    commandLine 'curl', '-X', 'POST', "https://modtale.net/api/v1/publish/${projectId}",
            '-H', "X-Api-Key: ${apiKey}",
            '-F', "file=@${jarFile.absolutePath}",
            '-F', "versionNumber=${project.version}",
            '-F', "gameVersions=Release 1.0",
            '-F', "changelog=Uploaded via Local Gradle Task"
}